const orgs = {
  "Kirkon Ala-aste": {
    "langs": [
      "C64 Assembly",
      "BASIC"
    ],
    "tools": [
      "Commodore 64",
      "Windows"
    ],
    "skills": [
      "Artificial intelligence"
    ]
  },
  "Kurikan Yläaste, Lukio": {
    "langs": [
      "Pascal",
      "Java",
      "JavaScript",
      "SQL"
    ],
    "tools": [
      "Windows",
      "Linux"
    ],
    "skills": [
      "Tracker music",
      "3D modeling",
      "Machine learning",
      "Artificial intelligence"
    ]
  },
  "Kurikan Kaupunki": {
    "langs": [],
    "tools": [],
    "skills": []
  },
  "Turvavartiointi M. Savela Ky": {
    "langs": [],
    "tools": [],
    "skills": []
  },
  "Tampere University of Technology": {
    "langs": [
      "C++",
      "Java",
      "J",
      "Ada",
      "Fortran",
      "Matlab/Octave",
      "Lisp",
      "Prolog",
      "SPARC Assembly",
      "ESSI",
      "JavaScript",
      "R",
      "Perl",
      "SQL",
      "LaTeX",
      "DOT"
    ],
    "tools": [
      "Linux",
      "PS3/Cell",
      "Subversion",
      "CVS",
      "IRC",
      "Glassfish",
      "Tomcat",
      "Apache",
      "GCC",
      "JavaEE"
    ],
    "skills": [
      "Mathematical modeling",
      "Signal processing"
    ]
  },
  "Roboteam": {
    "langs": [],
    "tools": [],
    "skills": []
  },
  "Finnpos Systems Oy": {
    "langs": [],
    "tools": [],
    "skills": []
  },
  "Elektrobit Oyj": {
    "langs": [],
    "tools": [],
    "skills": []
  },
  "Nice-business Solutions Oy": {
    "langs": [],
    "tools": [],
    "skills": []
  },
  "Neter": {
    "langs": [],
    "tools": [],
    "skills": []
  },
  "Cybercom Finland Oy": {
    "langs": [],
    "tools": [],
    "skills": []
  },
  "Sentido X-Tech Oy": {
    "langs": [
      "Python",
      "C++",
      "JavaScript"
    ],
    "tools": [
      "Linux",
      "Tensorflow",
      "Slack",
      "Git",
      "Trello",
      "node.js",
      "Azure",
      "Docker"
    ],
    "skills": [
      "Full-stack",
      "Architecture",
      "Machine learning",
      "Artificial intelligence",
      "Deep learning",
      "Signal processing",
      "Project management",
      "Machine vision"
    ]
  },
  "HERE Technologies": {
    "langs": [
      "Python",
      "JavaScript"
    ],
    "tools": [
      "Linux",
      "Tensorflow",
      "Git",
      "AWS",
      "Docker",
      "Redash",
      "Spark",
      "Kubernetes",
      "Kubeflow",
      "React",
      "Konva.js",
      "Kafka",
      "Protobuf"
    ],
    "skills": [
      "Full-stack",
      "Architecture",
      "Machine learning",
      "Artificial intelligence",
      "Deep learning",
      "Probabilistic inference",
      "Information theory",
      "Mathematical modeling",
      "Reinforcement learning",
      "Generative Adversarial Networks",
      "Variational models",
      "Mixture Density Networks",
      "Public speaking",
      "Game development"
    ]
  }
};

const projects = {
  "Kurikan Ryhti homepages and TV ads": {
    "org": "Kurikan Kaupunki",
    "langs": [
      "JavaScript",
      "HTML/CSS"
    ],
    "tools": [
      "Powerpoint",
      "Windows",
      "Lightwave 3D",
      "3ds Max"
    ],
    "skills": [
      "3D modeling",
      "Web design"
    ]
  },
  "Programming courses for 10-14 year-olds": {
    "org": "Kurikan Kaupunki",
    "langs": [
      "Java",
      "HTML/CSS"
    ],
    "tools": [
      "Windows",
      "Applets"
    ],
    "skills": [
      "Training"
    ]
  },
  "Eurobot": {
    "org": "Roboteam",
    "langs": [
      "C++",
      "Matlab/Octave",
      "LaTeX"
    ],
    "tools": [
      "Linux",
      "OpenCV",
      "IRC",
      "Subversion",
      "GCC"
    ],
    "skills": [
      "Robotics",
      "Architecture",
      "Artificial intelligence",
      "Signal processing",
      "Machine vision"
    ]
  },
  "Robotic Bartender": {
    "org": "Roboteam",
    "langs": [
      "Rapid",
      "C++",
      "Matlab/Octave",
      "Linux",
      "IRC",
      "Subversion"
    ],
    "tools": [
      "Qt",
      "GCC"
    ],
    "skills": [
      "Robotics",
      "Architecture"
    ]
  },
  "Finnpos F2": {
    "org": "Finnpos Systems Oy",
    "langs": [
      "Dynamic C",
      "Perl",
      "HTML/CSS"
    ],
    "tools": [
      "CVS",
      "Subversion",
      "Linux",
      "IRC"
    ],
    "skills": [
      "Cryptography",
      "Architecture",
      "Embedded systems",
      "Visa POS PED",
      "ISO 9001:2000",
      "Project management"
    ]
  },
  "Finnpos F3": {
    "org": "Finnpos Systems Oy",
    "langs": [
      "Java"
    ],
    "tools": [
      "CVS",
      "Subversion",
      "NetBeans",
      "Linux",
      "IRC"
    ],
    "skills": [
      "Cryptography",
      "Architecture",
      "Desktop apps",
      "ISO 9001:2000",
      "Project management"
    ]
  },
  "Linux driver, LG touchscreen": {
    "org": "Finnpos Systems Oy",
    "langs": [
      "C"
    ],
    "tools": [
      "CVS",
      "Subversion",
      "Linux",
      "IRC",
      "GCC"
    ],
    "skills": [
      "Driver programming",
      "Project management"
    ]
  },
  "VoIP System": {
    "org": "Finnpos Systems Oy",
    "langs": [
      "C++",
      "Java"
    ],
    "tools": [
      "CVS",
      "Subversion",
      "Eclipse",
      "Linux",
      "Windows",
      "IRC",
      "GCC"
    ],
    "skills": [
      "Architecture",
      "Audio codecs",
      "Signal processing",
      "Project management"
    ]
  },
  "Crypto infrastructure": {
    "org": "Finnpos Systems Oy",
    "langs": [
      "Java",
      "SQL",
      "LaTeX"
    ],
    "tools": [
      "CVS",
      "Subversion",
      "Eclipse",
      "Linux",
      "IRC",
      "GCC"
    ],
    "skills": [
      "Architecture",
      "Cryptography",
      "Certificates",
      "ISO 9001:2000",
      "Project management"
    ]
  },
  "Datamike billing/accounting": {
    "org": "Turvavartiointi M. Savela Ky",
    "langs": [
      "xBase"
    ],
    "tools": [
      "Windows"
    ],
    "skills": [
      "Billing"
    ]
  },
  "Rene RNC HSPA": {
    "org": "Elektrobit Oyj",
    "langs": [
      "C",
      "Python",
      "Perl",
      "LaTeX",
      "DOT"
    ],
    "tools": [
      "Subversion",
      "DSP",
      "OSEck",
      "Linux",
      "CWiki",
      "IRC",
      "GCC"
    ],
    "skills": [
      "DSP",
      "Embedded systems"
    ]
  },
  "Carbook": {
    "org": "Elektrobit Oyj",
    "langs": [
      "Java",
      "Python",
      "Perl",
      "Erlang",
      "RDF",
      "JavaScript",
      "SQL",
      "LaTeX"
    ],
    "tools": [
      "Subversion",
      "Glassfish",
      "Apache",
      "MySQL",
      "Linux",
      "CWiki",
      "IRC",
      "Vmware",
      "Git",
      "JavaEE",
      "OpenLayers",
      "Jena"
    ],
    "skills": [
      "Full-stack",
      "Architecture",
      "Semantic web",
      "Geographic Information Systems",
      "GPS"
    ]
  },
  "Identity Federation": {
    "org": "Nice-business Solutions Oy",
    "langs": [
      "Perl",
      "Java",
      "Python",
      "HTML/CSS",
      "Ruby",
      "JavaScript"
    ],
    "tools": [
      "Subversion",
      "Tomcat",
      "MySQL",
      "Apache",
      "Confluence",
      "Jira",
      "Jenkins",
      "IRC",
      "Linux",
      "Spring",
      "JavaEE",
      "Puppet",
      "JUnit",
      "JMeter",
      "JSP"
    ],
    "skills": [
      "Full-stack",
      "Architecture",
      "Cryptography",
      "Certificates"
    ]
  },
  "B2B Portal": {
    "org": "Nice-business Solutions Oy",
    "langs": [
      "Java",
      "Scala",
      "HTML/CSS",
      "JavaScript",
      "SQL"
    ],
    "tools": [
      "Subversion",
      "WebSphere",
      "Oracle",
      "Confluence",
      "Jira",
      "Jenkins",
      "Linux",
      "Spring",
      "JavaEE",
      "ScalaTest",
      "JUnit",
      "JSP"
    ],
    "skills": [
      "Full-stack"
    ]
  },
  "BPT": {
    "org": "Nice-business Solutions Oy",
    "langs": [
      "Java",
      "Scala",
      "HTML/CSS",
      "JavaScript",
      "SQL"
    ],
    "tools": [
      "Oracle",
      "WebSphere",
      "Subversion",
      "Confluence",
      "Jira",
      "Jenkins",
      "Sencha",
      "Linux",
      "Spring",
      "JavaEE",
      "ScalaTest",
      "JUnit",
      "JSP"
    ],
    "skills": [
      "Full-stack",
      "Architecture",
      "Geographic Information Systems"
    ]
  },
  "Drupal CMS": {
    "org": "Nice-business Solutions Oy",
    "langs": [
      "HTML/CSS",
      "JavaScript",
      "PHP"
    ],
    "tools": [
      "Drupal",
      "Subversion",
      "Eclipse",
      "Linux"
    ],
    "skills": [
      "Web design"
    ]
  },
  "Drupal concept app": {
    "org": "Cybercom Finland Oy",
    "langs": [
      "HTML/CSS",
      "JavaScript",
      "PHP"
    ],
    "tools": [
      "Git",
      "Drupal",
      "Linux"
    ],
    "skills": [
      "Web design"
    ]
  },
  "EURA funds management": {
    "org": "Cybercom Finland Oy",
    "langs": [
      "Java",
      "Scala",
      "Groovy",
      "HTML/CSS",
      "JavaScript",
      "SQL"
    ],
    "tools": [
      "Git",
      "Eclipse",
      "Vagrant",
      "Chef",
      "Spring",
      "Wicket",
      "JRebel",
      "Nginx",
      "MongoDB",
      "Ingres",
      "Confluence",
      "Jira",
      "Jenkins",
      "IRC",
      "Virtualbox",
      "Linux",
      "JavaEE",
      "Tomcat",
      "JUnit",
      "ScalaTest"
    ],
    "skills": [
      "Full-stack",
      "Architecture"
    ]
  },
  "Industrial calibration": {
    "org": "Cybercom Finland Oy",
    "langs": [
      "JavaScript",
      "TypeScript",
      "C",
      "Matlab/Octave",
      "R"
    ],
    "tools": [
      "Mercurial",
      "Git",
      "Eclipse",
      "MongoDB",
      "CouchDB",
      "Redis",
      "Angular",
      "Polymer",
      "Confluence",
      "Jira",
      "Jenkins",
      "IRC",
      "Linux",
      "WebGL",
      "node.js",
      "OpenStack",
      "Vagrant",
      "Chef",
      "DeltaCloud",
      "Mocha",
      "Karma",
      "Nginx"
    ],
    "skills": [
      "3D modeling",
      "Full-stack",
      "Architecture",
      "Mathematical modeling",
      "Cryptography",
      "Certificates",
      "Signal processing"
    ]
  },
  "Machinebook": {
    "org": "Cybercom Finland Oy",
    "langs": [
      "JavaScript",
      "LaTeX"
    ],
    "tools": [
      "Git",
      "Eclipse",
      "Polymer",
      "Slack",
      "Confluence",
      "Jira",
      "Linux"
    ],
    "skills": [
      "Full-stack",
      "Architecture",
      "Semantic web"
    ]
  },
  "Innovation Zone": {
    "org": "Cybercom Finland Oy",
    "langs": [
      "Java",
      "JavaScript",
      "Matlab/Octave",
      "UnityScript",
      "R",
      "SQL"
    ],
    "tools": [
      "Raspberry Pi",
      "Linux",
      "Android",
      "Unity3D",
      "Tensorflow",
      "XMPP",
      "Ejabberd",
      "Slack",
      "Virtualbox",
      "Git",
      "Confluence",
      "Jira",
      "Jenkins",
      "HBase",
      "node.js",
      "OpenShift",
      "OpenStack",
      "Blender",
      "Velocity"
    ],
    "skills": [
      "3D modeling",
      "Full-stack",
      "Architecture",
      "Machine learning",
      "Artificial intelligence",
      "Deep learning",
      "Signal processing",
      "Geographic Information Systems"
    ]
  },
  "Oskari": {
    "org": "Cybercom Finland Oy",
    "langs": [
      "Java",
      "JavaScript",
      "SQL"
    ],
    "tools": [
      "PostgreSQL",
      "Polymer",
      "Webpack",
      "Slack",
      "Virtualbox",
      "Git",
      "Confluence",
      "Jira",
      "Jenkins",
      "Linux",
      "Spring",
      "JavaEE",
      "node.js",
      "JUnit",
      "OpenLayers",
      "Nginx"
    ],
    "skills": [
      "Full-stack",
      "Architecture",
      "Geographic Information Systems"
    ]
  },
  "Suomi.fi": {
    "org": "Cybercom Finland Oy",
    "langs": [
      "Java",
      "JavaScript",
      "RDF",
      "SQL"
    ],
    "tools": [
      "Ansible",
      "Docker",
      "ElasticSearch",
      "React",
      "Angular",
      "Redis",
      "Jena",
      "Jira",
      "Jenkins",
      "Confluence",
      "Vagrant",
      "Webpack",
      "Flowdock",
      "Virtualbox",
      "Git",
      "Linux",
      "Spring",
      "JavaEE",
      "PostgreSQL",
      "ActiveMQ",
      "node.js",
      "Jetty",
      "OpenStack",
      "JUnit",
      "Mocha",
      "Nginx",
      "Spring Cloud Netflix"
    ],
    "skills": [
      "Full-stack",
      "Architecture",
      "Semantic web"
    ]
  },
  "Presentations": {
    "org": "Cybercom Finland Oy",
    "langs": [
      "LaTeX",
      "DOT",
      "JavaScript",
      "Solidity",
      "Python"
    ],
    "tools": [
      "Ethereum",
      "Tensorflow",
      "Git",
      "Prezi",
      "Confluence",
      "Polymer"
    ],
    "skills": [
      "Machine learning",
      "Artificial intelligence",
      "Deep learning",
      "Public speaking"
    ]
  },
  "Hacking competitions": {
    "org": "Cybercom Finland Oy",
    "langs": [
      "Python",
      "JavaScript",
      "HTML/CSS",
      "DOT"
    ],
    "tools": [
      "ElasticSearch",
      "Logstash",
      "Kibana",
      "AWS",
      "Bluemix",
      "Git",
      "Linux",
      "Android",
      "Cordova",
      "Bluetooth",
      "Phaser",
      "Ionic",
      "Angular",
      "Polymer",
      "Slack",
      "Docker",
      "Confluence",
      "node.js"
    ],
    "skills": [
      "Tracker music",
      "Full-stack",
      "Architecture",
      "Machine learning",
      "Artificial intelligence",
      "Deep learning",
      "Indoor positioning"
    ]
  },
  "Advisory":  {
    "org": "Cybercom Finland Oy",
    "langs": [],
    "tools": [
    ],
    "skills": [
      "Value Creation Canvas",
      "Machine learning",
      "Artificial intelligence",
      "Deep learning",
      "Blockchain"
    ]
  },
  "NFC Cordova app": {
    "org": "Neter",
    "langs": [
      "Java",
      "JavaScript"
    ],
    "tools": [
      "Cordova",
      "Android",
      "NFC",
      "Git",
      "Linux"
    ],
    "skills": [
      "Full-stack"
    ]
  },
  "Therapeutic Phaser game": {
    "org": "Neter",
    "langs": [
      "JavaScript"
    ],
    "tools": [
      "Heroku",
      "Phaser",
      "Ionic",
      "Angular",
      "MongoDB",
      "Git",
      "Linux",
      "Android",
      "node.js"
    ],
    "skills": [
      "Full-stack",
      "Architecture",
      "Game development"
    ]
  },
  "Research": {
    "org": "Neter",
    "langs": [
      "Python",
      "Lua",
      "Solidity",
      "LaTeX"
    ],
    "tools": [
      "OpenShift",
      "Linux",
      "Raspberry Pi",
      "AWS",
      "Google App Engine",
      "Tensorflow",
      "Torch",
      "Unity3D",
      "Blender",
      "Ethereum",
      "UnityScript",
      "Facebook API",
      "Virtualbox",
      "Git",
      "CUDA",
      "Spring",
      "JavaEE",
      "CouchDB",
      "node.js",
      "OpenGL",
      "WebGL",
      "JUnit",
      "Mocha"
    ],
    "skills": [
      "3D modeling",
      "Full-stack",
      "Architecture",
      "Machine learning",
      "Artificial intelligence",
      "Deep learning",
      "Blockchain",
      "Signal processing",
      "Geographic Information Systems",
      "GPS",
      "Mixture Density Networks"
    ]
  }
};

const epochs = {
  "1989–1994": ["Kirkon Ala-aste"],
  "1995–2000": ["Kurikan Yläaste, Lukio", "Kurikan Kaupunki", "Turvavartiointi M. Savela Ky"],
  "2001–2008": ["Roboteam", "Finnpos Systems Oy", "Tampere University of Technology", "Elektrobit Oyj"],
  "2009–2012": ["Elektrobit Oyj", "Nice-business Solutions Oy", "Neter"],
  "2012–2018": ["Neter", "Cybercom Finland Oy"],
  "2018–": ["Neter", "Cybercom Finland Oy", "Sentido X-Tech Oy", "HERE Technologies"]
};

const timeline = ["1989–1994", "1995–2000", "2001–2008", "2009–2012", "2012–2017", "2018–"];

Object.keys(projects).forEach(p => {orgs[projects[p].org].projects = [];});
Object.keys(projects).forEach(p => {orgs[projects[p].org].projects.push(p);});

// The information is structured into tiers, which contain ids of nodes and direct references to other nodes on other tiers.
// Tier is a unit that can be switched on or off on the visualization, causing new dynamic connections skipping
// the tier be inferred transitively.
// The edges are directional towards the higher index in tierIds, and the directed graph does not have loops.
const tierIds = ["epochs", "orgs", "projects", "langs", "skills", "tools"];
const tierEpochs = Object.keys(epochs).map(e => ({tier: 0, group: 1, id: e, children: epochs[e]}));
const tierOrgs = Object.keys(orgs).map(o => ({tier: 1, group: 2, id: o, children: orgs[o].langs.concat(orgs[o].tools).concat(orgs[o].projects).concat(orgs[o].skills).filter(x => x != null)}));
const tierProjects = Object.keys(projects).map(p => ({tier: 2, group: 3, id: p, children: projects[p].langs.concat(projects[p].tools).concat(projects[p].skills)}));
const tierLangs = [... new Set(Object.keys(orgs).map(o => orgs[o].langs).reduce((x, y) => x.concat(y), [])
  .concat(Object.keys(projects).map(p => projects[p].langs).reduce((x, y) => x.concat(y), [])))]
  .map(l => ({tier: 3, group: 4, id: l, children: []}));
const tierTools = [... new Set(Object.keys(orgs).map(o => orgs[o].tools).reduce((x, y) => x.concat(y), [])
    .concat(Object.keys(projects).map(p => projects[p].tools).reduce((x, y) => x.concat(y), [])))]
    .map(t => ({tier: 4, group: 5, id: t, children: []}));
const tierSkills = [... new Set(Object.keys(orgs).map(o => orgs[o].skills).reduce((x, y) => x.concat(y), [])
    .concat(Object.keys(projects).map(p => projects[p].skills).reduce((x, y) => x.concat(y), [])))]
    .map(s => ({tier: 5, group: 6, id: s, children: []}));

for (var i = 1; i < tierEpochs.length ; i++) {
  tierEpochs[i-1].children.push(tierEpochs[i].id);
}

const tiers = [
  {visible: true, name: "Epochs", tier: tierEpochs},
  {visible: true, name: "Organizations", tier: tierOrgs},
  {visible: true, name: "Projects", tier: tierProjects},
  {visible: true, name: "Languages", tier: tierLangs},
  {visible: false, name: "Tools", tier: tierTools},
  {visible: false, name: "Skills", tier: tierSkills}];

const nodeForId = new Map();
tiers.forEach(t => t.tier.forEach(n => nodeForId.set(n.id, n)));
const allNodes = [... nodeForId.values()];

function getChildrenFor(nodeName) {
  const node = nodeForId.get(nodeName);
  return [... new Set(node.children.map(c => {
    const child = nodeForId.get(c);
    console.log(JSON.stringify(node) + ": " + c);
    if (tiers[child.tier].visible) {
      return [child.id];
    } else {
      // We must return the children transitively.
      return getChildrenFor(child.id);
    }
  }).reduce((x, y) => x.concat(y), []))];
}

function redraw() {
  $("#spinner").show();
  tiers[0].visible = $("#cbEpochs").is(":checked");
  tiers[1].visible = $("#cbOrgs").is(":checked");
  tiers[2].visible = $("#cbProjects").is(":checked");
  tiers[3].visible = $("#cbLanguages").is(":checked");
  tiers[4].visible = $("#cbTools").is(":checked");
  tiers[5].visible = $("#cbSkills").is(":checked");

  const visibleNodes = allNodes.filter(n => tiers[n.tier].visible);
  const visNodes = new vis.DataSet(visibleNodes.map(n => ({id: n.id, label: n.id, group: n.group})));

  const visEdges = new vis.DataSet(
      visibleNodes.map(n => getChildrenFor(n.id).map(c => {
        if (nodeForId.get(c).tier != n.tier) {
          return {from: c, to: n.id};
        } else {
          // Epoch-to-epoch connections.
          return {from: n.id, to: c};
        }
      })).reduce((x, y) => x.concat(y), []));

  // create a network
  const container = document.getElementById('vis');
  const data = {
    nodes: visNodes,
    edges: visEdges
  };
  const options = {};
  const network = new vis.Network(container, data, options);
  network.once('stabilized', function() {
    var scaleOption = { scale : 1.4 };
    network.moveTo(scaleOption);
    $("#spinner").hide();
  });
}

$(function() {
  redraw();
  $("#cbEpochs").change(() => {redraw();});
  $("#cbOrgs").change(() => {redraw();});
  $("#cbProjects").change(() => {redraw();});
  $("#cbLanguages").change(() => {redraw();});
  $("#cbTools").change(() => {redraw();});
  $("#cbSkills").change(() => {redraw();});
});
